###########################################################
# PUPPET MANAGED                                          #
# Do not edit this file on a server node unless you       #
# are willing to have your changes overwritten by         #
# Puppet.  If you really want to change the contents      #
# of this file, change it in the puppet subversion        #
# repository and check it out on the ops server.          #
###########################################################

<%
# set up a lot of defaults.
datadir =    instance_path + '/' + 'data'
bindir  =    instance_path + '/' + 'binlog'
logdir  =    instance_path + '/' + 'log'
tempdir =    instance_path + '/' + 'tmp'

-%>

# mysql.conf file for MySQL <%= name %> running MySQL <%= version %>
[mysqld]
basedir                         = <%= basedir %>
datadir                         = <%= datadir %>
tmpdir                          = <%= tempdir %>
socket                          = <%= instance_path %>/mysql.sock
pid-file                        = <%= instance_path %>/mysql.pid
user                            = mysql


##############
# Networking #
##############

port                            = <%= port %>
skip_name_resolve
max_allowed_packet              = 64M
max_connections                 = <%= max_connections %>
wait_timeout                    = 10
connect_timeout                 = 300


###########
# Logging #
###########
log_error				            		= <%= logdir %>/mysql.log
<%
# MySQL 5.0 and 5.1 use different ways of specifying the slow query log
if (version.index('5.0') == 0)
-%>
# Log slow queries to this file
log_slow_queries				      = <%= logdir %>/mysql_slow_query.log
log-queries-not-using-indexes = 0
<% else -%>
slow_query_log                = 1
slow_query_log_file           = <%= logdir %>/mysql_slow_query.log
<% end -%>
long_query_time                 = 5

<% if replication_enabled -%>
########################
# Replication Settings #
########################
log_bin                         = <%= bindir %>/bin
relay-log                       = <%= bindir %>/relay-bin
relay-log-index                 = <%= bindir %>/relay-bin.index
expire_logs_days                = <%= expire_log_days %>

# Log slave updates so that any machine may be a master
log_slave_updates

# report as <%= hostname + '.' + name %> to master
report-host=<%= hostname + '.' + name %>

<% #automatically generate a unique master server-id from IP / port -%>
server-id                       = <%= "#{ipaddress_eth0_1.split('.').last}#{port}" %>

<% replicate_ignore_db.each do |db| -%>
replicate_ignore_db             = <%= db %>
<% end -%>
<% replicate_ignore_table.each do |table| -%>
replicate_ignore_table          = <%= table %>
<% end -%>
<% replicate_do_db.each do |db| -%>
replicate_do_db                 = <%= db %>
<% end -%>
<% replicate_do_table.each do |table| -%>
replicate_do_table              = <%= table %>
<% end -%>

<% end # if replication_enabled -%>

<% # set read_only mode based on read_only variable %>
read_only                       = <%= read_only ? 1 : 0 %>


# Character Set
character_set_server            = utf8
collation_server                = utf8_general_ci

# Allow fulltext searches to find words smaller than 4 characters
ft_min_word_len                 = 3

####################################
# Buffers, Threads, Caches, Limits #
####################################
<%
# every setting below is configurable
# in puppet with the mysql_instance
# define.  Defaults for these are
# set in the mysql_instance define
-%>
tmp_table_size                  = <%= tmp_table_size                   %>
max_heap_table_size             = <%= max_heap_table_size              %>
max_tmp_tables                  = <%= max_tmp_tables                   %>

join_buffer_size                = <%= join_buffer_size                 %>
read_buffer_size                = <%= read_buffer_size                 %>
sort_buffer_size                = <%= sort_buffer_size                 %>

table_cache                     = <%= table_cache                      %>
<% if (version.index('5.1') == 0) -%>
table_definition_cache          = <%= table_definition_cache           %>
<% end -%>
open_files_limit                = <%= open_files_limit                 %>

thread_cache_size               = <%= thread_cache_size                %>
thread_concurrency              = <%= thread_concurrency               %>

query_cache_size                = <%= query_cache_size                 %>
query_cache_limit               = <%= query_cache_limit                %>
tmp_table_size                  = <%= tmp_table_size                   %>
read_rnd_buffer_size            = <%= read_rnd_buffer_size             %>


###################
# MyISAM Settings #
###################
key_buffer_size                 = <%= key_buffer_size                 %>
myisam_sort_buffer_size         = <%= myisam_sort_buffer_size         %>
myisam_max_sort_file_size       = <%= myisam_max_sort_file_size       %>


###################
# InnoDB Settings #
###################
innodb_file_per_table           = <%= innodb_file_per_table           %>
innodb_status_file              = <%= innodb_status_file              %>
innodb_support_xa               = <%= innodb_support_xa               %>
innodb_flush_log_at_trx_commit  = <%= innodb_flush_log_at_trx_commit  %>
innodb_buffer_pool_size         = <%= innodb_buffer_pool_size         %>
innodb_log_file_size            = <%= innodb_log_file_size            %>
innodb_log_group_home_dir       = <%= datadir                         %>
innodb_flush_method             = <%= innodb_flush_method             %>
innodb_thread_concurrency       = <%= innodb_thread_concurrency       %>
innodb_concurrency_tickets      = <%= innodb_concurrency_tickets      %>
innodb_doublewrite              = <%= innodb_doublewrite              %>

# always enable federated storage engine
federated                       = 1
